<div metal:use-macro="load: ../shared/_layout.pt">
    <div metal:fill-slot="content" tal:omit-tag="True">

        <div class="help is-success" tal:condition="info">${ info }</div>
        <div id="message-area"></div>

        <form method="post" action="/vineyards/${vineyard_id}/spray_records/${spray_id}/new">

            <div class="field">
                <label class="label">Operator</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select name="operator_id" required>
                            <option value="">-- Select Operator --</option>
                            <option tal:repeat="op operators" tal:attributes="value op.id; 
                                       selected python:op.id == operator.id if operator else False"
                                tal:content="op.name">
                            </option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="field">
                <label class="label">Date Completed</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <input class="input" type="date" name="date_completed" value="${date_completed}" required />
                    </div>
                </div>
            </div>

            <div class=" field">
                <label class="label">Growth Stage</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select name="growth_stage_id" required>
                            <option value="">-- Select Growth Stage --</option>
                            <option tal:repeat="stage growth_stages" value="${stage.id}"
                                tal:attributes="selected python:stage.id == growth_stage_id if growth_stage_id else False">
                                ${stage.el_number} –
                                ${stage.description}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="field">
                <label class="label">Chemicals</label>
                <div tal:repeat="chem chemicals" class="content">
                    <label class="label">${chem.name} Batch #</label>
                    <div class="control">
                        <input type="hidden" name="chemical_ids" value="${chem.id}" />
                        <input class="input" type="text" name="batch_number_${chem.id}"
                            tal:attributes="value python:form.get(f'batch_number_{chem.id}', '') if form else ''"
                            required />
                    </div>
                </div>
            </div>

            <div class="field">
                <label class="label">Hours Taken</label>
                <div class="control">
                    <input class="input" type="number" name="hours_taken" step="0.1" min="0"
                        tal:attributes="value hours_taken" />
                </div>
            </div>

            <div class="field">
                <label class="label">Temperature (°C)</label>
                <div class="control">
                    <input class="input" type="number" name="temperature" step="1" min="-10" max="50"
                        tal:attributes="value temperature" />
                </div>
            </div>

            <div class="field">
                <label class="label">Relative Humidity (%)</label>
                <div class="control">
                    <input class="input" type="number" name="relative_humidity" step="1" min="0" max="100"
                        tal:attributes="value relative_humidity" />
                </div>
            </div>

            <div class="field">
                <label class="label">Wind Speed (km/h)</label>
                <div class="control">
                    <input class="input" type="number" name="wind_speed" step="1" min="0"
                        tal:attributes="value wind_speed" />
                </div>
            </div>

            <div class="field">
                <label class="label">Wind Direction</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select name="wind_direction" required>
                            <option value="">-- Select Wind Direction --</option>
                            <option tal:repeat="direction wind_directions" tal:attributes="value direction.name;
                                       selected python:direction.name == wind_direction if wind_direction else False"
                                tal:content="direction.name" />
                        </select>
                    </div>
                </div>
            </div>

            <div class="field">
                <div id="selections">
                    <label class="label">Complete for:</label>
                    <div class="buttons">
                        <a hx-get="/vineyards/${vineyard_id}/spray_records/${spray_id}/select_all"
                            hx-target="#selections" hx-swap="outerHTML" hx-push-url="false"
                            class="button is-info is-small loading-button is-outlined">
                            <span class="icon loading-spinner">
                                <i class="fas fa-spinner"></i>
                            </span>
                            <span class="normal-text">Select all Units</span>
                            <span class="loading-text">Loading...</span>
                        </a>
                    </div>
                    <div tal:repeat="spray_record spray_records" class="control">
                        <label tal:condition="not spray_record.complete" class="checkbox is-block mb-2">
                            <input type="checkbox" name="management_unit_ids"
                                value="${spray_record.management_unit.id}" />
                            &nbsp;
                            <i class="fas fa-wine-bottle"
                                tal:attributes="class python:'fas fa-wine-bottle has-text-danger' if spray_record.management_unit.variety.wine_colour.name == 'Red' else 'fas fa-wine-bottle has-text-grey'">
                            </i>&nbsp;
                            ${spray_record.management_unit.name} &mdash;
                            ${spray_record.management_unit.variety.name}
                        </label>
                    </div>
                    <div tal:repeat="spray_record spray_records" class="control">
                        <label tal:condition="spray_record.complete" class="is-block mb-2">
                            &nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;
                            <i class="fas fa-wine-bottle"
                                tal:attributes="class python:'fas fa-wine-bottle has-text-danger' if spray_record.management_unit.variety.wine_colour.name == 'Red' else 'fas fa-wine-bottle has-text-grey'">
                            </i>&nbsp;
                            ${spray_record.management_unit.name} &mdash;
                            ${spray_record.management_unit.variety.name}
                            &mdash; Complete
                        </label>
                    </div>
                </div>
            </div>

            <div class="field mt-4">
                <div class="control">
                    <button class="button is-primary is-fullwidth" type="submit">Submit Spray Records</button>
                    <a class="button is-link is-fullwidth" href="/vineyards/${vineyard_id}">
                        ← Back to Vineyard Details
                    </a>
                </div>
            </div>

        </form>
    </div>
</div>